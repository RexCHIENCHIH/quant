//@version=5
strategy(title="Commodity Channel Index", shorttitle="CCI",overlay=false)

/每次收K都清空委託單
strategy.cancel_all()

//未平倉的進場價
Entry_Price = strategy.opentrades.entry_price(strategy.opentrades - 1) 

//CCI = D / 0.015 * MD
Length = input.int(20,"K棒長度")
Mult = input.float(0.015,"偏差係數")
TP = input.source(hlc3, "Source")
CCI_Gap = input.int(100,"CCI閥值")

// 計算TP的n根K棒的簡單移動平均
TP_MA = ta.ema(TP,Length)

//偏差 (D):TP與其n根K棒均值的差值，可能為負數
D = TP - TP_MA

//計算偏差的絕對值的平均 (Mean Deviation, MD)
MD = ta.ema(math.abs(D),Length)

//CCI
CCI = D / (Mult * MD)

LongCondition  = ta.crossover(CCI,CCI_Gap)
ShortCondition = ta.crossunder(CCI,-CCI_Gap)

LongExit = ta.crossunder(CCI,0)
ShortExit = ta.crossover(CCI,0)

if LongCondition 
    strategy.entry("LE",strategy.long)

if LongExit  and strategy.position_size > 0
    strategy.close("LE")

// 空單委託
if ShortCondition 
    strategy.entry("SE", strategy.short) 
if ShortExit  and strategy.position_size < 0
    strategy.close("SE")

//繪圖
plot(CCI,"CCI",color.red)
hline(CCI_Gap)
hline(-CCI_Gap)
hline(0)
